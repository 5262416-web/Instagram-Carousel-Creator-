<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Instagram Carousel Creator</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0f1115;--panel:#171a21;--ink:#e8ecf1;--muted:#98a2b3;--accent:#7c9cff;--line:#222736;--btn:#23293a;--warn:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--bg),rgba(15,17,21,.6));backdrop-filter: blur(6px);}
    .wrap{max-width:960px;margin:0 auto;padding:12px}
    .col{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    textarea{width:100%;min-height:140px;resize:vertical;background:#0a0c12;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px;font-size:14px;line-height:1.5}
    select,input[type="number"],input[type="text"],input[type="color"]{width:100%;background:#0a0c12;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:8px}
    input[type="number"]{appearance:textfield}
    .controls{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{appearance:none;border:1px solid var(--line);background:var(--btn);color:var(--ink);padding:10px 12px;border-radius:12px;font-weight:600}
    .btn.secondary{background:#0a0c12}
    .btn.warn{background:#2b0f13;border-color:#3a1218;color:#ffb4b4}
    .hint{color:var(--muted);font-size:12px}
    details{background:#0a0c12;border:1px solid var(--line);border-radius:12px;padding:10px}
    summary{cursor:pointer;color:var(--ink);font-weight:600}
    .slides{display:flex;flex-direction:column;gap:14px;margin-top:12px}
    .slideCard{position:relative;background:#0b0e15;border:1px solid var(--line);border-radius:14px;padding:10px}
    canvas.thumb{
      width:100%;height:auto;border-radius:10px;border:1px solid var(--line);background:#000;
      touch-action: pan-y; /* –¥–∞—ë—Ç —Å–∫—Ä–æ–ª–ª–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–∞–∂–µ –ø–æ —Ñ–æ—Ç–æ */
    }
    .cardActions{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:10px}
    .iconBtn{display:inline-flex;align-items:center;gap:8px}
    .iconBtn svg{width:18px;height:18px}
    footer{display:flex;justify-content:center;padding:24px}
    .clear{opacity:.8}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:999px;background:#101522;border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .accent{color:var(--accent)}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:10px;flex:1 1 auto">
        <div class="badge">üì∏ Instagram Carousel Creator <span class="accent">1080√ó1350</span></div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="col">
      <label for="story">Story (separate slides with an empty line)</label>
      <textarea id="story" placeholder="Paste your story here.

Each paragraph separated by an empty line becomes a new slide."></textarea>
      <div class="hint" style="margin-top:8px">Auto-save every ~3s (this session). Slides generate automatically.</div>

      <details style="margin-top:12px">
        <summary>Advanced style options (optional)</summary>
        <div class="controls" style="margin-top:10px">
          <div>
            <label>Font family</label>
            <select id="fontFamily">
              <option value="'Montserrat', Arial, sans-serif">Montserrat</option>
              <option value="Arial, sans-serif">Arial</option>
              <option value="'Helvetica Neue', Helvetica, Arial, sans-serif">Helvetica</option>
              <option value="'Times New Roman', Times, serif">Times New Roman</option>
              <option value="Georgia, serif">Georgia</option>
              <option value="'Courier New', Courier, monospace">Courier New</option>
            </select>
          </div>
          <div>
            <label>Text align</label>
            <select id="textAlign">
              <option value="left">Left</option>
              <option value="center">Center</option>
              <option value="right">Right</option>
            </select>
          </div>

          <div style="grid-column:1 / span 2; display:flex; align-items:center; gap:8px; margin-top:4px">
            <input id="showArrow" type="checkbox">
            <label for="showArrow" style="margin:0">Show ‚Äúswipe right‚Äù arrow on all but last slide</label>
          </div>

          <div><label>Base font size (px)</label><input id="fontSize" type="number" min="12" max="120" step="1" value="45" /></div>
          <div><label>Line height</label><input id="lineHeight" type="number" min="1" max="2.4" step="0.01" value="1.25" /></div>
          <div><label>Text padding (px)</label><input id="padding" type="number" min="0" max="160" step="1" value="64" /></div>

          <div><label>Fade height (% of canvas)</label><input id="overlayHeightPct" type="number" min="10" max="90" value="20" /></div>
          <div><label>Backdrop opacity (0‚Äì1, bottom)</label><input id="overlayAlpha" type="number" min="0" max="1" step="0.05" value="0.6" /></div>
          <div><label>Gradient hardness (0.5‚Äì3)</label><input id="overlayHardness" type="number" min="0.5" max="3" step="0.05" value="1" /></div>

          <div><label>Corner radius (px)</label><input id="cornerRadius" type="number" min="0" max="120" step="1" value="0" /></div>
          <div><label>Text color</label><input id="textColor" type="text" value="#ffffff" /></div>
          <div><label>Shadow (0‚Äì1)</label><input id="textShadow" type="number" min="0" max="1" step="0.01" value="0.8" /></div>

          <div><label>Text bottom offset (px)</label><input id="textBottomOffset" type="number" min="0" max="300" step="1" value="48" /></div>
          <div><label>Background color (under photos)</label><input id="bgColor" type="color" value="#000000" /></div>
        </div>
      </details>

      <div class="hint" style="margin:12px 0 8px">Use ‚ÄúReplace photo‚Äù to add an image ‚Ä¢ Tap the download icon to save JPG</div>
      <div id="slides" class="slides"></div>
    </div>
  </main>

  <footer>
    <button id="clearBtn" class="btn warn clear">Clear Results ‚Äî reset all (text, photos, settings)</button>
  </footer>

  <input id="filePicker" type="file" accept="image/*" style="display:none" />

  <script>
    const W = 1080, H = 1350; // 4:5 portrait
    const state = {
      slides: [],
      settings: {
        fontFamily: "'Montserrat', Arial, sans-serif",
        fontSize: 45,
        textAlign: 'left',
        padding: 64,
        lineHeight: 1.25,
        textColor: '#ffffff',
        overlayAlpha: 0.6,        // bottom opacity
        overlayHeightPct: 20,     // gradient height (%)
        overlayHardness: 1,       // curve steepness
        cornerRadius: 0,
        textShadow: 0.8,
        showArrow: false,
        bgColor: '#000000',
        textBottomOffset: 48      // distance from bottom to bottom edge of text block
      },
      autosaveTS: 0
    };

    const elStory = document.getElementById('story');
    const elSlides = document.getElementById('slides');
    const elFile = document.getElementById('filePicker');

    // bind settings
    const bindSetting = (id, key, transform=(v)=>v, rev=(v)=>v) => {
      const el = document.getElementById(id);
      if(!el) return;
      if(el.type==='checkbox'){ el.checked = !!state.settings[key]; }
      else { el.value = rev(state.settings[key]); }
      const update = () => { state.settings[key] = transform(el.type==='checkbox' ? el.checked : el.value); renderAll(); queueAutosave(); };
      el.addEventListener('input', update);
    };
    bindSetting('fontFamily','fontFamily');
    bindSetting('textAlign','textAlign');
    bindSetting('fontSize','fontSize', v=>parseInt(v,10));
    bindSetting('lineHeight','lineHeight', v=>parseFloat(v));
    bindSetting('padding','padding', v=>parseInt(v,10));
    bindSetting('overlayHeightPct','overlayHeightPct', v=>parseInt(v,10));
    bindSetting('overlayAlpha','overlayAlpha', v=>parseFloat(v));
    bindSetting('overlayHardness','overlayHardness', v=>parseFloat(v));
    bindSetting('cornerRadius','cornerRadius', v=>parseInt(v,10));
    bindSetting('textColor','textColor');
    bindSetting('textShadow','textShadow', v=>parseFloat(v));
    bindSetting('textBottomOffset','textBottomOffset', v=>parseInt(v,10));
    bindSetting('showArrow','showArrow', v=>v==='on' ? true : document.getElementById('showArrow').checked);
    bindSetting('bgColor','bgColor');

    // text -> slides
    function splitTextToSlides(t){
      const parts = t.replace(/\r/g,'').split(/\n\s*\n/g).map(s=>s.trim()).filter(Boolean);
      const old = state.slides;
      state.slides = parts.map((p,i)=>({ text: p, imgSrc: (old[i] && old[i].imgSrc) || undefined }));
      renderSlidesList(); renderAll();
    }
    elStory.addEventListener('input', ()=>{ splitTextToSlides(elStory.value); queueAutosave(); });

    // build UI
    function createSlideCard(index){
      const wrap = document.createElement('div'); wrap.className = 'slideCard';

      const c = document.createElement('canvas'); c.width = W; c.height = H; c.className='thumb'; c.dataset.index = index;
      wrap.appendChild(c);

      const actions = document.createElement('div'); actions.className='cardActions';
      const replaceBtn = document.createElement('button'); replaceBtn.className='btn secondary'; replaceBtn.textContent='Replace photo';
      replaceBtn.addEventListener('click',(e)=>{ e.stopPropagation(); replacePhoto(index); });
      actions.appendChild(replaceBtn);

      const dlBtn = document.createElement('button'); dlBtn.className='btn secondary iconBtn'; dlBtn.title='Download JPG';
      dlBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 3a1 1 0 011 1v9.586l2.293-2.293a1 1 0 111.414 1.414l-4.001 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L11 13.586V4a1 1 0 011-1z"/><path d="M5 20a2 2 0 002 2h10a2 2 0 002-2v-3a1 1 0 10-2 0v3H7v-3a1 1 0 10-2 0v3z"/></svg>`;
      dlBtn.addEventListener('click', async ()=>{ await downloadSlide(index); });
      actions.appendChild(dlBtn);

      wrap.appendChild(actions);

      renderSlideCanvas(c, index);
      return wrap;
    }

    function renderSlidesList(){
      elSlides.innerHTML = '';
      state.slides.forEach((_,i)=>elSlides.appendChild(createSlideCard(i)));
      if(state.slides.length===0){
        const empty = document.createElement('div'); empty.className='hint';
        empty.textContent = 'No slides yet. Type your story ‚Äî slides appear automatically.'; elSlides.appendChild(empty);
      }
    }
    function renderAll(){ document.querySelectorAll('canvas.thumb').forEach(cv=>renderSlideCanvas(cv, parseInt(cv.dataset.index,10))); }

    // helpers
    function roundedClip(ctx, x, y, w, h, r){
      if(!r) return false;
      const rr = Math.min(r, w/2, h/2);
      ctx.save(); ctx.beginPath();
      ctx.moveTo(x+rr,y);
      ctx.arcTo(x+w,y,x+w,y+h,rr);
      ctx.arcTo(x+w,y+h,x,y+h,rr);
      ctx.arcTo(x,y+h,x,y,rr);
      ctx.arcTo(x,y,x+w,y,rr);
      ctx.closePath(); ctx.clip();
      return true;
    }
    function endClip(ctx, clipped){ if(clipped){ ctx.restore(); } }

    // gradient from bottom (opaque*alpha) ‚Üí transparent top, with hardness exponent
    function drawGradientBackdrop(ctx, x, y, w, h, alphaBottom, hardness){
      const steps = 10; // approximate exponential gradient
      const grd = ctx.createLinearGradient(0, y+h, 0, y);
      for(let i=0;i<=steps;i++){
        const t = i/steps;
        const a = alphaBottom * Math.pow(1 - t, hardness); // denser near bottom as hardness grows
        grd.addColorStop(1 - t, `rgba(0,0,0,${Math.max(0, Math.min(1, a))})`);
      }
      ctx.fillStyle = grd; ctx.fillRect(x, y, w, h);
    }

    function wrapLines(ctx, text, maxW){
      const words = (text||'').split(/\s+/);
      const lines = []; let line = '';
      for(const w of words){
        const test = line ? line + ' ' + w : w;
        if(ctx.measureText(test).width > maxW && line){ lines.push(line); line = w; }
        else { line = test; }
      }
      if(line) lines.push(line);
      return lines;
    }

    // single place rendering (what you see = what you download)
    function drawFrame(ctx, slide, index){
      // background
      ctx.fillStyle = state.settings.bgColor || '#000';
      ctx.fillRect(0,0,W,H);

      const clipped = roundedClip(ctx,0,0,W,H,state.settings.cornerRadius);

      // photo (cover)
      if(slide.imgSrc && slide._img && slide._img.complete){
        const img = slide._img;
        const rImg = img.width / img.height, rCan = W / H;
        let dw=W, dh=H;
        if(rImg > rCan){ dh = W / rImg; dw = W; } else { dw = H * rImg; dh = H; }
        const cx = (W - dw)/2, cy = (H - dh)/2;
        ctx.drawImage(img, cx, cy, dw, dh);
      }

      // compute text metrics (independent of overlay height)
      const fs = state.settings.fontSize;
      const lh = Math.max(1, state.settings.lineHeight) * fs;
      ctx.font = `${fs}px ${state.settings.fontFamily}`;
      ctx.textAlign = state.settings.textAlign;
      const pad = state.settings.padding;
      const maxW = W - pad*2;
      const lines = wrapLines(ctx, slide.text, maxW);
      const textBlockHeight = Math.min(lines.length * lh, H); // rough
      const bottomEdge = H - state.settings.textBottomOffset;
      const firstBaseline = bottomEdge - (textBlockHeight - fs) - pad;

      // overlay: under text, independent height
      const overlayH = Math.round(H * (state.settings.overlayHeightPct/100));
      const overlayTop = H - overlayH;
      drawGradientBackdrop(ctx, 0, overlayTop, W, overlayH, state.settings.overlayAlpha, state.settings.overlayHardness);

      // text
      const x = (state.settings.textAlign==='left') ? pad : (state.settings.textAlign==='center' ? W/2 : W - pad);
      let y = firstBaseline;
      ctx.fillStyle = state.settings.textColor;
      if(state.settings.textShadow>0){
        ctx.save();
        ctx.shadowColor = `rgba(0,0,0,${state.settings.textShadow})`;
        ctx.shadowBlur = 12; ctx.shadowOffsetX = 0; ctx.shadowOffsetY = 0;
        for(const ln of lines){ ctx.fillText(ln, x, y); y += lh; if(y > H - pad) break; }
        ctx.restore();
      } else {
        for(const ln of lines){ ctx.fillText(ln, x, y); y += lh; if(y > H - pad) break; }
      }

      // optional arrow
      if(state.settings.showArrow && index < state.slides.length-1){
        ctx.save(); ctx.globalAlpha = 0.75; ctx.fillStyle = '#ffffff';
        const size = 36, ax = W - 24, ay = H/2;
        ctx.beginPath(); ctx.moveTo(ax - size/2, ay - size/2);
        ctx.lineTo(ax + size/2, ay); ctx.lineTo(ax - size/2, ay + size/2);
        ctx.closePath(); ctx.fill(); ctx.restore();
      }

      endClip(ctx, clipped);
    }

    // render onto on-screen canvas
    function renderSlideCanvas(cv, index){
      const s = state.slides[index];
      const ctx = cv.getContext('2d');
      // ensure image object cached
      if(s.imgSrc && !s._img){
        s._img = new Image();
        s._img.onload = ()=>{ drawFrame(ctx, s, index); };
        s._img.src = s.imgSrc;
      }
      drawFrame(ctx, s, index);
    }

    // render to an offscreen canvas AND wait for image if needed
    function renderToCanvas(index, canvas){
      return new Promise((resolve)=>{
        const s = state.slides[index];
        const ctx = canvas.getContext('2d');

        const doDraw = ()=>{ drawFrame(ctx, s, index); resolve(); };

        if(s.imgSrc){
          if(s._img && s._img.complete){ doDraw(); }
          else {
            const img = new Image();
            img.onload = ()=>{ s._img = img; doDraw(); };
            img.src = s.imgSrc;
          }
        } else {
          doDraw();
        }
      });
    }

    // replace photo
    function replacePhoto(index){
      elFile.onchange = async (e)=>{
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        const dataURL = await fileToDataURL(file);
        state.slides[index].imgSrc = dataURL;
        state.slides[index]._img = null;
        renderAll(); queueAutosave(); elFile.value='';
      };
      elFile.click();
    }
    function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

    // download (await render to avoid black images)
    async function downloadSlide(index){
      const off = document.createElement('canvas'); off.width=W; off.height=H;
      await renderToCanvas(index, off);
      const a = document.createElement('a'); a.href = off.toDataURL('image/jpeg', 0.92); a.download = `slide-${index+1}.jpg`;
      document.body.appendChild(a); a.click(); a.remove();
    }

    // autosave
    const SAVE_KEY='icc_session_v9';
    function queueAutosave(){ state.autosaveTS=Date.now(); }
    setInterval(()=>{ if(!state.autosaveTS) return;
      if(Date.now()-state.autosaveTS>=2900){ try{
        const payload={slides:state.slides.map(s=>({text:s.text,imgSrc:s.imgSrc})),settings:state.settings,story:elStory.value};
        sessionStorage.setItem(SAVE_KEY, JSON.stringify(payload)); state.autosaveTS=0;
      }catch(e){} } },1000);

    function restore(){
      try{
        const raw=sessionStorage.getItem(SAVE_KEY); if(!raw) return; const data=JSON.parse(raw);
        Object.assign(state.settings, data.settings||{});
        ['fontFamily','textAlign','fontSize','lineHeight','padding','overlayHeightPct','overlayAlpha','overlayHardness','cornerRadius','textColor','textShadow','textBottomOffset','showArrow','bgColor']
          .forEach(id=>{ const el=document.getElementById(id); if(!el) return; if(el.type==='checkbox'){ el.checked=!!state.settings[id]; } else { el.value=state.settings[id]; } });
        state.slides=(data.slides||[]).map(s=>({text:s.text||'', imgSrc:s.imgSrc||null, _img:null}));
        elStory.value=data.story||'';
      }catch(e){}
    }

    document.getElementById('clearBtn').addEventListener('click', ()=>{
      if(!confirm('Reset everything to defaults?')) return;
      state.slides=[]; elStory.value='';
      Object.assign(state.settings, {
        fontFamily: "'Montserrat', Arial, sans-serif",
        fontSize: 45, textAlign:'left', padding:64, lineHeight:1.25, textColor:'#ffffff',
        overlayAlpha:0.6, overlayHeightPct:20, overlayHardness:1,
        cornerRadius:0, textShadow:0.8, textBottomOffset:48,
        showArrow:false, bgColor:'#000000'
      });
      ['fontFamily','textAlign','fontSize','lineHeight','padding','overlayHeightPct','overlayAlpha','overlayHardness','cornerRadius','textColor','textShadow','textBottomOffset','showArrow','bgColor']
        .forEach(id=>{ const el=document.getElementById(id); if(!el) return; if(el.type==='checkbox'){ el.checked=!!state.settings[id]; } else { el.value=state.settings[id]; } });
      sessionStorage.removeItem(SAVE_KEY); renderSlidesList(); renderAll();
    });

    // init
    restore(); renderSlidesList(); renderAll(); if(elStory.value) splitTextToSlides(elStory.value);
  </script>
</body>
  </html>
