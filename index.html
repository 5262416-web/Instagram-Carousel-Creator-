<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Instagram Carousel Creator</title>

  <!-- Web fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Roboto:wght@400;700&family=Open+Sans:wght@400;700&family=PT+Sans:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{ --bg:#0f1115; --panel:#171a21; --ink:#e8ecf1; --muted:#98a2b3; --accent:#7c9cff; --line:#222736; --btn:#23293a; --warn:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--bg),rgba(15,17,21,.6));backdrop-filter:blur(6px)}
    .wrap{max-width:960px;margin:0 auto;padding:12px}
    .col{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    textarea{width:100%;min-height:120px;resize:vertical;background:#0a0c12;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px;font-size:14px;line-height:1.5}
    select,input[type="number"],input[type="text"],input[type="range"]{width:100%;background:#0a0c12;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:8px}
    .controls{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{appearance:none;border:1px solid var(--line);background:var(--btn);color:var(--ink);padding:10px 12px;border-radius:12px;font-weight:600}
    .btn.secondary{background:#0a0c12}
    .btn.warn{background:#2b0f13;border-color:#3a1218;color:#ffb4b4}
    .hint{color:var(--muted);font-size:12px}
    details{background:#0a0c12;border:1px solid var(--line);border-radius:12px;padding:10px}
    summary{cursor:pointer;color:var(--ink);font-weight:600}
    .slides{display:flex;flex-direction:column;gap:14px;margin-top:12px}
    .slideCard{position:relative;background:#0b0e15;border:1px solid var(--line);border-radius:14px;padding:10px}
    canvas.thumb{width:100%;height:auto;border-radius:10px;border:1px solid var(--line);background:#000}
    .cardActions{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:10px}
    .iconBtn{display:inline-flex;align-items:center;gap:8px}
    .iconBtn svg{width:18px;height:18px}
    footer{display:flex;justify-content:center;padding:24px}
    .clear{opacity:.8}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:999px;background:#101522;border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .accent{color:var(--accent)}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:10px;flex:1 1 auto">
        <div class="badge">ðŸ“¸ Instagram Carousel Creator <span class="accent">1080Ã—1320</span></div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="col">
      <label for="story">Story (each slide = paragraph separated by blank line)</label>
      <textarea id="story" placeholder="Paste story here.
Each paragraph becomes its own slide.
Use **bold** and *italic* if needed."></textarea>

      <details style="margin-top:12px">
        <summary>Advanced style options</summary>

        <!-- ===== First slide (cover) settings FIRST ===== -->
        <div class="controls" style="margin-top:10px">
          <div style="grid-column:1/-1;color:#9aa4b2;font-weight:700">First slide â€” cover title</div>
          <div><label>Cover font</label>
            <select id="firstTitleFontFamily">
              <option value="'Montserrat', Arial, sans-serif">Montserrat SemiBold</option>
              <option value="Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif">Impact</option>
              <option value="Roboto, Arial, sans-serif">Roboto</option>
              <option value="'Open Sans', Arial, sans-serif">Open Sans</option>
              <option value="'PT Sans', Arial, sans-serif">PT Sans</option>
              <option value="'Helvetica Neue', Helvetica, Arial, sans-serif">Helvetica</option>
              <option value="Arial, sans-serif">Arial</option>
            </select>
          </div>
          <div>
            <label>Cover font size (px)</label>
            <input id="firstTitleFontSize" type="range" min="24" max="160" step="1" value="85" />
          </div>
          <div>
            <label>Cover vertical position (% from top)</label>
            <input id="firstTitleYPercent" type="range" min="5" max="95" step="1" value="80" />
          </div>
        </div>

        <!-- ===== Other slides â€” TITLE settings ===== -->
        <div class="controls" style="margin-top:10px">
          <div style="grid-column:1/-1;color:#9aa4b2;font-weight:700">Other slides â€” TITLE</div>
          <div><label>Title font</label>
            <select id="titleFontFamily">
              <option value="'Montserrat', Arial, sans-serif">Montserrat SemiBold</option>
              <option value="Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif">Impact</option>
              <option value="Roboto, Arial, sans-serif">Roboto</option>
              <option value="'Open Sans', Arial, sans-serif">Open Sans</option>
              <option value="'PT Sans', Arial, sans-serif">PT Sans</option>
              <option value="'Helvetica Neue', Helvetica, Arial, sans-serif">Helvetica</option>
              <option value="Arial, sans-serif">Arial</option>
            </select>
          </div>
          <div><label>Title font size (px)</label><input id="titleFontSize" type="number" min="20" max="160" step="1" value="65" /></div>
        </div>

        <!-- ===== Other slides â€” BODY settings ===== -->
        <div class="controls" style="margin-top:10px">
          <div style="grid-column:1/-1;color:#9aa4b2;font-weight:700">Other slides â€” BODY</div>
          <div><label>Body font</label>
            <select id="fontFamily">
              <option value="Arial, sans-serif">Arial</option>
              <option value="'Helvetica Neue', Helvetica, Arial, sans-serif">Helvetica</option>
              <option value="Roboto, Arial, sans-serif">Roboto</option>
              <option value="'Open Sans', Arial, sans-serif">Open Sans</option>
              <option value="'PT Sans', Arial, sans-serif">PT Sans</option>
              <option value="Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif">Impact</option>
              <option value="'Montserrat', Arial, sans-serif">Montserrat</option>
            </select>
          </div>
          <div><label>Body font size (px)</label><input id="fontSize" type="number" min="16" max="120" step="1" value="40" /></div>

          <div><label>Text align</label>
            <select id="textAlign"><option value="left">Left</option><option value="center">Center</option><option value="right">Right</option></select>
          </div>
          <div><label>Text padding (px)</label><input id="padding" type="number" min="0" max="200" value="64" /></div>
          <div><label>Line height</label><input id="lineHeight" type="number" min="1" max="2.4" step="0.05" value="1.25" /></div>
          <div><label>Text bottom offset (px)</label><input id="textBottomOffset" type="number" min="0" max="600" value="130" /></div>
          <div><label>Text color</label><input id="textColor" type="text" value="#ffffff" /></div>
          <div><label>Text shadow (0â€“1)</label><input id="textShadow" type="number" min="0" max="1" step="0.05" value="0.8" /></div>

          <!-- Shadow under text (not used on slide #1) -->
          <div><label>Fade height (% of canvas)</label><input id="overlayHeightPct" type="number" min="5" max="80" step="1" value="60" /></div>
          <div><label>Backdrop opacity (0â€“1)</label><input id="overlayAlpha" type="number" min="0" max="1" step="0.01" value="1" /></div>
          <div><label>Corner radius (px)</label><input id="cornerRadius" type="number" min="0" max="40" step="1" value="0" /></div>
        </div>
      </details>

      <div id="slides" class="slides"></div>
    </div>
  </main>

  <footer>
    <button id="clearBtn" class="btn warn clear">Clear Results â€” reset all</button>
  </footer>

  <input id="filePicker" type="file" accept="image/*" style="display:none" />

  <script>
    const W=1080, H=1320;

    const state={
      slides:[],
      settings:{
        // First slide (cover)
        firstTitleFontFamily:"'Montserrat', Arial, sans-serif",
        firstTitleFontWeight:600,   // semibold
        firstTitleFontSize:85,
        firstTitleYPercent:80,      // 0 = top, 100 = bottom

        // Other slides â€” title
        titleFontFamily:"'Montserrat', Arial, sans-serif",
        titleFontWeight:600,
        titleFontSize:65,

        // Other slides â€” body
        fontFamily:'Arial, sans-serif',
        fontSize:40,

        textAlign:'left',
        padding:64,
        lineHeight:1.25,
        textColor:'#ffffff',
        textShadow:0.8,
        textBottomOffset:130,

        // Backdrop (not applied on slide #1)
        overlayHeightPct:60,
        overlayAlpha:1,
        cornerRadius:0
      }
    };

    const elStory=document.getElementById('story');
    const elSlides=document.getElementById('slides');
    const elFile=document.getElementById('filePicker');

    // Split text to slides
    function splitTextToSlides(t){
      const parts=t.replace(/\r/g,'').split(/\n\s*\n/g).map(s=>s.trim()).filter(Boolean);
      const old=state.slides;
      state.slides=parts.map((p,i)=>({text:p,imgSrc:(old[i]&&old[i].imgSrc)||undefined,_img:null}));
      renderSlidesList(); renderAll();
    }
    elStory.addEventListener('input',()=>splitTextToSlides(elStory.value));

    // Inline formatting (**bold**, *italic*)
    function parseInline(text){
      const tokens=[]; let i=0;
      while(i<text.length){
        if(text.startsWith('**',i) || text.startsWith('__',i)){
          const m=text.substr(i,2), e=text.indexOf(m,i+2);
          if(e!==-1){ tokens.push({t:text.slice(i+2,e),b:true,i:false}); i=e+2; continue; }
          tokens.push({t:text.substr(i,2),b:false,i:false}); i+=2; continue;
        }
        if(text[i]==='*' || text[i]==='_'){
          const m=text[i], e=text.indexOf(m,i+1);
          if(e!==-1){ tokens.push({t:text.slice(i+1,e),b:false,i:true}); i=e+1; continue; }
          tokens.push({t:m,b:false,i:false}); i+=1; continue;
        }
        let j=i; while(j<text.length && !text.startsWith('**',j) && !text.startsWith('__',j) && text[j]!=='*' && text[j]!=='_') j++;
        tokens.push({t:text.slice(i,j),b:false,i:false}); i=j;
      }
      return tokens;
    }

    // Font builders
    function buildFont(fs,fam,weight,b,i){
      // order: italic, bold, weight, size family
      const w = weight ? (weight+' ') : '';
      const bstr = b ? 'bold ' : '';
      const istr = i ? 'italic ' : '';
      return `${istr}${bstr}${w}${fs}px ${fam}`;
    }
    function setFont(ctx,fs,fam,b,i,weight){ ctx.font = buildFont(fs,fam,weight,b,i); }

    // Line layout with mixed runs
    function layoutLines(ctx,tokens,maxW,fs,fam,weight){
      const lines=[]; let line=[], w=0;
      const meas=(txt,b,i)=>{ ctx.font=buildFont(fs,fam,weight,b,i); return ctx.measureText(txt).width; };
      for(const tok of tokens){
        const parts=tok.t.split(/(\s+)/);
        for(const p of parts){
          if(!p) continue;
          const ww=meas(p,tok.b,tok.i);
          if(w+ww>maxW && line.length){
            lines.push({runs:line,width:w});
            line=[{text:p,b:tok.b,i:tok.i,w:ww}]; w=ww;
          } else {
            line.push({text:p,b:tok.b,i:tok.i,w:ww}); w+=ww;
          }
        }
      }
      if(line.length) lines.push({runs:line,width:w});
      return lines;
    }

    // Title detection (other slides)
    function isUppercaseLine(str){
      const letters=str.replace(/[^A-Za-zÐ-Ð¯ÐÐ°-ÑÑ‘Ð†Ñ–Ð‡Ñ—Ð„Ñ”ÒÒ‘]/g,'');
      if(!letters) return false;
      return letters === letters.toUpperCase();
    }
    function extractTitleBody(text, slideIndex){
      const hasNewline = text.includes('\n');
      const firstLine = hasNewline ? text.split('\n')[0] : text;
      const rest = hasNewline ? text.slice(firstLine.length+1) : '';
      if(slideIndex===0){ return { title:firstLine.trim(), body:'' }; } // cover: only title
      if(hasNewline && isUppercaseLine(firstLine.trim())){ return { title:firstLine.trim(), body:rest.trim() }; }
      return { title:'', body:text };
    }

    // Rounded clip
    function clipRoundRect(ctx, x, y, w, h, r){
      if(!r) return false;
      const rr=Math.min(r, Math.min(w,h)/2);
      ctx.save(); ctx.beginPath();
      ctx.moveTo(x+rr,y);
      ctx.arcTo(x+w,y,  x+w,y+h, rr);
      ctx.arcTo(x+w,y+h,x,  y+h, rr);
      ctx.arcTo(x,  y+h,x,  y,   rr);
      ctx.arcTo(x,  y,  x+w,y,   rr);
      ctx.closePath(); ctx.clip(); return true;
    }

    // Backdrop fade for non-cover slides
    function drawBottomFade(ctx){
      const oh=Math.max(1, Math.round(H*(state.settings.overlayHeightPct/100)));
      const yBottom=H, yTop=H-oh;
      const g=ctx.createLinearGradient(0,yBottom,0,yTop);
      const a=state.settings.overlayAlpha;
      g.addColorStop(0.00, `rgba(0,0,0,${a})`);
      g.addColorStop(0.35, `rgba(0,0,0,${a*0.7})`);
      g.addColorStop(0.70, `rgba(0,0,0,${a*0.35})`);
      g.addColorStop(1.00, `rgba(0,0,0,0)`);
      ctx.fillStyle=g; ctx.fillRect(0,yTop,W,oh);
    }

    // Rendering
    function renderSlidesList(){
      elSlides.innerHTML='';
      if(state.slides.length===0){
        const empty=document.createElement('div'); empty.className='hint';
        empty.textContent='Start with text â€” slides will appear automatically.'; elSlides.appendChild(empty); return;
      }
      state.slides.forEach((_,i)=>elSlides.appendChild(createSlideCard(i)));
    }

    function createSlideCard(index){
      const wrap=document.createElement('div'); wrap.className='slideCard';
      const c=document.createElement('canvas'); c.width=W; c.height=H; c.className='thumb'; c.dataset.index=index; wrap.appendChild(c);
      const actions=document.createElement('div'); actions.className='cardActions';
      const replaceBtn=document.createElement('button'); replaceBtn.className='btn secondary'; replaceBtn.textContent='Replace image';
      replaceBtn.addEventListener('click',()=>replacePhoto(index)); actions.appendChild(replaceBtn);
      const dlBtn=document.createElement('button'); dlBtn.className='btn secondary iconBtn'; dlBtn.title='Download JPG';
      dlBtn.innerHTML=`<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 3a1 1 0 011 1v9.586l2.293-2.293a1 1 0 111.414 1.414l-4.001 4a1 1 0 01-1.414 0l-4-4a1 1 0 111.414-1.414L11 13.586V4a1 1 0 011-1z"/><path d="M5 20a2 2 0 002 2h10a2 2 0 002-2v-3a1 1 0 10-2 0v3H7v-3a1 1 0 10-2 0v3z"/></svg>`;
      dlBtn.addEventListener('click',()=>downloadSlide(index)); actions.appendChild(dlBtn);
      wrap.appendChild(actions);
      renderSlideCanvas(c,index);
      return wrap;
    }

    function renderAll(){
      document.querySelectorAll('canvas.thumb').forEach(cv=>renderSlideCanvas(cv,parseInt(cv.dataset.index,10)));
    }

    function renderSlideCanvas(cv,index){
      const s=state.slides[index];
      const ctx=cv.getContext('2d');

      const clipped=clipRoundRect(ctx,0,0,W,H,state.settings.cornerRadius);
      ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H);

      if(s.imgSrc){
        if(!s._img){
          s._img=new Image();
          s._img.onload=()=>renderSlideCanvas(cv,index);
          s._img.src=s.imgSrc;
          if(clipped) ctx.restore();
          return;
        }
        const img=s._img;
        const scale=Math.max(W/img.width,H/img.height);
        const dw=img.width*scale, dh=img.height*scale;
        const dx=(W-dw)/2, dy=(H-dh)/2;
        ctx.drawImage(img,dx,dy,dw,dh);
      }

      // Backdrop only for non-cover slides
      if(index!==0) drawBottomFade(ctx);
      if(clipped) ctx.restore();

      // ----- Layout -----
      const pad=state.settings.padding;
      const align=state.settings.textAlign;
      const color=state.settings.textColor;
      const shadow=state.settings.textShadow;

      if(index===0){
        // Cover: only title (first line)
        const firstLine=(s.text||'').split('\n')[0]||'';
        const tokens=parseInline(firstLine);
        const maxW=W - pad*2;
        const fs=state.settings.firstTitleFontSize;
        const fam=state.settings.firstTitleFontFamily;
        const weight=state.settings.firstTitleFontWeight;
        const lines=layoutLines(ctx,tokens,maxW,fs,fam,weight);

        // vertical position: percent from top
        const yTarget = H*(state.settings.firstTitleYPercent/100);
        const totalHeightExceptLast = lines.slice(0,-1).reduce((sum,l)=>sum+(fs*state.settings.lineHeight),0);
        let y = yTarget - totalHeightExceptLast;

        lines.forEach(line=>{
          let xStart=pad;
          if(align==='center') xStart=(W-line.width)/2;
          if(align==='right')  xStart=W-pad-line.width;
          let x=xStart;
          for(const run of line.runs){
            setFont(ctx,fs,fam,!!run.b,!!run.i,weight);
            ctx.fillStyle=color;
            if(shadow>0){ ctx.save(); ctx.shadowColor=`rgba(0,0,0,${shadow})`; ctx.shadowBlur=12; ctx.fillText(run.text,x,y); ctx.restore(); }
            else { ctx.fillText(run.text,x,y); }
            ctx.save(); setFont(ctx,fs,fam,!!run.b,!!run.i,weight); x += ctx.measureText(run.text).width; ctx.restore();
          }
          y += fs*state.settings.lineHeight;
        });
        return;
      }

      // Other slides: title (if detected) + body
      const {title, body}=extractTitleBody(s.text||'', index);
      const maxW=W - pad*2;

      // Title
      if(title){
        const fsT=state.settings.titleFontSize, famT=state.settings.titleFontFamily, wT=state.settings.titleFontWeight;
        const linesT=layoutLines(ctx,parseInline(title),maxW,fsT,famT,wT);
        // compute start y so that entire block (title+body) ends at bottom offset
        const fsB=state.settings.fontSize;
        const linesB = body ? layoutLines(ctx,parseInline(body),maxW,fsB,state.settings.fontFamily,400) : [];
        const totalH = linesT.length*(fsT*state.settings.lineHeight) + linesB.length*(fsB*state.settings.lineHeight);
        let y = H - state.settings.textBottomOffset - (totalH - (fsT*state.settings.lineHeight));

        linesT.forEach(line=>{
          let xStart=pad; if(align==='center') xStart=(W-line.width)/2; if(align==='right') xStart=W-pad-line.width;
          let x=xStart;
          for(const run of line.runs){
            setFont(ctx,fsT,famT,!!run.b,!!run.i,wT);
            ctx.fillStyle=color;
            if(shadow>0){ ctx.save(); ctx.shadowColor=`rgba(0,0,0,${shadow})`; ctx.shadowBlur=12; ctx.fillText(run.text,x,y); ctx.restore(); }
            else { ctx.fillText(run.text,x,y); }
            ctx.save(); setFont(ctx,fsT,famT,!!run.b,!!run.i,wT); x += ctx.measureText(run.text).width; ctx.restore();
          }
          y += fsT*state.settings.lineHeight;
        });

        // Body
        linesB.forEach(line=>{
          let xStart=pad; if(align==='center') xStart=(W-line.width)/2; if(align==='right') xStart=W-pad-line.width;
          let x=xStart;
          for(const run of line.runs){
            setFont(ctx,state.settings.fontSize,state.settings.fontFamily,!!run.b,!!run.i,400);
            ctx.fillStyle=color;
            if(shadow>0){ ctx.save(); ctx.shadowColor=`rgba(0,0,0,${shadow})`; ctx.shadowBlur=12; ctx.fillText(run.text,x,y); ctx.restore(); }
            else { ctx.fillText(run.text,x,y); }
            ctx.save(); setFont(ctx,state.settings.fontSize,state.settings.fontFamily,!!run.b,!!run.i,400); x += ctx.measureText(run.text)
