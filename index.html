<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Instagram Carousel Creator</title>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Open+Sans:wght@400;700&family=Roboto:wght@400;700&family=PT+Sans:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0f1115;--panel:#171a21;--ink:#e8ecf1;--muted:#98a2b3;--accent:#7c9cff;--line:#222736;--btn:#23293a;--warn:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--bg),rgba(15,17,21,.6));backdrop-filter: blur(6px);}
    .wrap{max-width:960px;margin:0 auto;padding:12px}
    .col{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    textarea{width:100%;min-height:140px;resize:vertical;background:#0a0c12;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px;font-size:14px;line-height:1.5}
    select,input[type="number"],input[type="text"],input[type="color"]{width:100%;background:#0a0c12;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:8px}
    input[type="number"]{appearance:textfield}
    .controls{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{appearance:none;border:1px solid var(--line);background:var(--btn);color:var(--ink);padding:10px 12px;border-radius:12px;font-weight:600}
    .btn.secondary{background:#0a0c12}
    .btn.warn{background:#2b0f13;border-color:#3a1218;color:#ffb4b4}
    .hint{color:var(--muted);font-size:12px}
    details{background:#0a0c12;border:1px solid var(--line);border-radius:12px;padding:10px}
    summary{cursor:pointer;color:var(--ink);font-weight:600}
    .slides{display:flex;flex-direction:column;gap:14px;margin-top:12px}
    .slideCard{position:relative;background:#0b0e15;border:1px solid var(--line);border-radius:14px;padding:10px}
    canvas.thumb{width:100%;height:auto;border-radius:10px;border:1px solid var(--line);background:#000;touch-action: pan-y;}
    .cardActions{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:10px}
    .iconBtn{display:inline-flex;align-items:center;gap:8px}
    .iconBtn svg{width:18px;height:18px}
    footer{display:flex;justify-content:center;padding:24px}
    .clear{opacity:.8}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:999px;background:#101522;border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .accent{color:var(--accent)}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:10px;flex:1 1 auto">
        <div class="badge">üì∏ Instagram Carousel Creator <span class="accent">1080√ó1350</span></div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <div class="col">
      <label for="story">Story (separate slides with an empty line)</label>
      <textarea id="story" placeholder="Paste your story here.

Each paragraph separated by an empty line becomes a new slide. Use **double asterisks** or __underscores__ for bold."></textarea>
      <div class="hint" style="margin-top:8px">Auto-save every ~3s (this session). Slides generate automatically.</div>

      <details style="margin-top:12px">
        <summary>Advanced style options (optional)</summary>
        <div class="controls" style="margin-top:10px">
          <div>
            <label>Font family</label>
            <select id="fontFamily">
              <option value="'Montserrat', Arial, sans-serif">Montserrat</option>
              <option value="Impact, Haettenschweiler, 'Arial Narrow Bold', sans-serif">Impact</option>
              <option value="'Open Sans', Arial, sans-serif">Open Sans Regular</option>
              <option value="Roboto, Arial, sans-serif">Roboto Regular</option>
              <option value="'PT Sans', Arial, sans-serif">PT Sans</option>
              <option value="Arial, sans-serif">Arial</option>
              <option value="'Helvetica Neue', Helvetica, Arial, sans-serif">Helvetica</option>
              <option value="'Times New Roman', Times, serif">Times New Roman</option>
              <option value="Georgia, serif">Georgia</option>
              <option value="'Courier New', Courier, monospace">Courier New</option>
            </select>
          </div>
          <div>
            <label>Text align</label>
            <select id="textAlign">
              <option value="left">Left</option>
              <option value="center">Center</option>
              <option value="right">Right</option>
            </select>
          </div>

          <div><label>Base font size (px)</label><input id="fontSize" type="number" value="40" /></div>
          <div><label>Line height</label><input id="lineHeight" type="number" step="0.01" value="1.25" /></div>
          <div><label>Text padding (px)</label><input id="padding" type="number" value="64" /></div>

          <div><label>Fade height (% of canvas)</label><input id="overlayHeightPct" type="number" value="20" /></div>
          <div><label>Darkest opacity (0‚Äì1)</label><input id="overlayAlpha" type="number" step="0.05" value="0.8" /></div>
          <div><label>Gradient curve (0.5‚Äì3)</label><input id="overlayHardness" type="number" step="0.05" value="1" /></div>

          <div><label>Corner radius (px)</label><input id="cornerRadius" type="number" value="0" /></div>
          <div><label>Text color</label><input id="textColor" type="text" value="#ffffff" /></div>
          <div><label>Shadow (0‚Äì1)</label><input id="textShadow" type="number" step="0.01" value="0.8" /></div>

          <div><label>Text bottom offset (px)</label><input id="textBottomOffset" type="number" value="150" /></div>
          <div><label>Background color (under photos)</label><input id="bgColor" type="color" value="#000000" /></div>
        </div>
      </details>

      <div class="hint" style="margin:12px 0 8px">Use ‚ÄúReplace photo‚Äù to add an image ‚Ä¢ Tap the download icon to save JPG</div>
      <div id="slides" class="slides"></div>
    </div>
  </main>

  <footer>
    <button id="clearBtn" class="btn warn clear">Clear Results ‚Äî reset all (text, photos, settings)</button>
  </footer>

  <input id="filePicker" type="file" accept="image/*" style="display:none" />

  <script>
    const W = 1080, H = 1350;
    const state = {
      slides: [],
      settings: {
        fontFamily: "'Montserrat', Arial, sans-serif",
        fontSize: 40,
        textAlign: 'left',
        padding: 64,
        lineHeight: 1.25,
        textColor: '#ffffff',
        overlayAlpha: 0.8,
        overlayHeightPct: 20,
        overlayHardness: 1,
        cornerRadius: 0,
        textShadow: 0.8,
        bgColor: '#000000',
        textBottomOffset: 150
      }
    };

    const elStory = document.getElementById('story');
    const elSlides = document.getElementById('slides');
    const elFile = document.getElementById('filePicker');

    // Bold parsing (**...** or __...__)
    function parseBold(text){
      const tokens = [];
      const regex = /(\*\*|__)(.*?)\1/g;
      let lastIndex = 0, match;
      while((match = regex.exec(text)) !== null){
        if(match.index > lastIndex){
          tokens.push({text: text.slice(lastIndex, match.index), bold:false});
        }
        tokens.push({text: match[2], bold:true});
        lastIndex = regex.lastIndex;
      }
      if(lastIndex < text.length){
        tokens.push({text: text.slice(lastIndex), bold:false});
      }
      return tokens;
    }

    function splitTextToSlides(t){
      const parts = t.replace(/\r/g,'').split(/\n\s*\n/g).map(s=>s.trim()).filter(Boolean);
      const old = state.slides;
      state.slides = parts.map((p,i)=>({ text: p, imgSrc: (old[i] && old[i].imgSrc) || undefined, _img: null }));
      renderSlidesList(); renderAll();
    }
    elStory.addEventListener('input', ()=>{ splitTextToSlides(elStory.value); });

    function createSlideCard(index){
      const wrap = document.createElement('div'); wrap.className = 'slideCard';
      const c = document.createElement('canvas'); c.width = W; c.height = H; c.className='thumb'; c.dataset.index = index;
      wrap.appendChild(c);
      const actions = document.createElement('div'); actions.className='cardActions';
      const replaceBtn = document.createElement('button'); replaceBtn.className='btn secondary'; replaceBtn.textContent='Replace photo';
      replaceBtn.addEventListener('click',()=>replacePhoto(index));
      actions.appendChild(replaceBtn);
      const dlBtn = document.createElement('button'); dlBtn.className='btn secondary iconBtn'; dlBtn.innerHTML='‚¨á'; dlBtn.addEventListener('click',()=>downloadSlide(index));
      actions.appendChild(dlBtn);
      wrap.appendChild(actions);
      renderSlideCanvas(c,index);
      return wrap;
    }

    function renderSlidesList(){
      elSlides.innerHTML = '';
      state.slides.forEach((_,i)=>elSlides.appendChild(createSlideCard(i)));
    }

    function wrapLines(ctx, tokens, maxW){
      const lines=[]; let lineTokens=[]; let width=0;
      tokens.forEach(tok=>{
        const words = tok.text.split(/(\s+)/);
        words.forEach(w=>{
          const metrics = ctx.measureText(w);
          if(width+metrics.width>maxW && lineTokens.length){
            lines.push(lineTokens); lineTokens=[tok.bold?{text:w,bold:true}:{text:w,bold:false}]; width=metrics.width;
          } else {
            lineTokens.push(tok.bold?{text:w,bold:true}:{text:w,bold:false}); width+=metrics.width;
          }
        });
      });
      if(lineTokens.length) lines.push(lineTokens);
      return lines;
    }

    function drawGradientBackdrop(ctx, x, y, w, h, alphaBottom, hardness){
      const steps=24;
      const grd=ctx.createLinearGradient(0,y+h,0,y);
      for(let i=0;i<=steps;i++){
        const t=i/steps;
        const a=alphaBottom*Math.pow(1-t,hardness);
        grd.addColorStop(1-t,`rgba(0,0,0,${a})`);
      }
      ctx.fillStyle=grd; ctx.fillRect(x,y,w,h);
    }

    function renderSlideCanvas(cv,index){
      const s=state.slides[index]; const ctx=cv.getContext('2d');
      ctx.fillStyle=state.settings.bgColor; ctx.fillRect(0,0,W,H);
      if(s.imgSrc){ if(!s._img){ s._img=new Image(); s._img.onload=()=>renderSlideCanvas(cv,index); s._img.src=s.imgSrc; return; }
        const img=s._img; const rImg=img.width/img.height,rCan=W/H; let dw=W,dh=H;
        if(rImg>rCan){ dh=W/rImg; dw=W; } else { dw=H*rImg; dh=H; }
        const cx=(W-dw)/2, cy=(H-dh)/2; ctx.drawImage(img,cx,cy,dw,dh);}
      // overlay
      const overlayH=Math.round(H*(state.settings.overlayHeightPct/100));
      const overlayTop=H-overlayH;
      drawGradientBackdrop(ctx,0,overlayTop,W,overlayH,state.settings.overlayAlpha,state.settings.overlayHardness);
      // text
      const fs=state.settings.fontSize, lh=fs*state.settings.lineHeight;
      const pad=state.settings.padding; const maxW=W-pad*2;
      let tokens=parseBold(s.text);
      ctx.textAlign=state.settings.textAlign;
      const lines=wrapLines(ctx,tokens,maxW);
      let y=H-state.settings.textBottomOffset-(lines.length-1)*lh;
      const x=(state.settings.textAlign==='left')?pad:(state.settings.textAlign==='center'?W/2:W-pad);
      lines.forEach(line=>{
        let offsetX=x;
        line.forEach(tok=>{
          ctx.font=`${tok.bold?'bold':''} ${fs}px ${state.settings.fontFamily}`;
          ctx.fillStyle=state.settings.textColor;
          ctx.fillText(tok.text,offsetX,y);
          offsetX+=ctx.measureText(tok.text).width;
        });
        y+=lh;
      });
    }

    function replacePhoto(index){
      elFile.onchange=async e=>{
        const f=e.target.files[0]; if(!f)return;
        const data=await fileToDataURL(f); state.slides[index].imgSrc=data; state.slides[index]._img=null; renderAll(); elFile.value='';
      }; elFile.click();
    }
    function fileToDataURL(file){return new Promise(res=>{const fr=new FileReader();fr.onload=()=>res(fr.result);fr.readAsDataURL(file);});}
    function renderAll(){document.querySelectorAll('canvas.thumb').forEach(cv=>renderSlideCanvas(cv,parseInt(cv.dataset.index))); }
    function downloadSlide(index){const cv=document.querySelectorAll('canvas.thumb')[index];const a=document.createElement('a');a.href=cv.toDataURL('image/jpeg',0.92);a.download=`slide-${index+1}.jpg`;a.click();}
  </script>
</body>
</html>
