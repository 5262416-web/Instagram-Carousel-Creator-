<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Instagram Carousel Creator</title>
  <style>
    :root{--bg:#0f1115;--panel:#171a21;--ink:#e8ecf1;--muted:#98a2b3;--accent:#7c9cff;--line:#222736;--btn:#23293a;--warn:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--bg),rgba(15,17,21,.6));backdrop-filter: blur(6px)}
    .wrap{max-width:960px;margin:0 auto;padding:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 320px;background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    textarea{width:100%;min-height:120px;resize:vertical;background:#0a0c12;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px;font-size:14px;line-height:1.5}
    select,input[type="number"],input[type="text"]{width:100%;background:#0a0c12;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:8px}
    .controls{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{appearance:none;border:1px solid var(--line);background:var(--btn);color:var(--ink);padding:10px 12px;border-radius:12px;font-weight:600}
    .btn.secondary{background:#0a0c12}
    .btn.warn{background:#2b0f13;border-color:#3a1218;color:#ffb4b4}
    .hint{color:var(--muted);font-size:12px}
    details{background:#0a0c12;border:1px solid var(--line);border-radius:12px;padding:10px}
    summary{cursor:pointer;color:var(--ink);font-weight:600}
    .slides{display:flex;gap:10px;overflow-x:auto;padding-bottom:8px}
    .slideCard{min-width:180px;background:#0b0e15;border:1px solid var(--line);border-radius:14px;padding:8px}
    .slideHead{display:flex;align-items:center;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:6px}
    canvas.thumb{width:100%;height:auto;border-radius:10px;border:1px solid var(--line);background:#000}
    footer{display:flex;justify-content:center;padding:24px}
    .clear{opacity:.8}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:999px;background:#101522;border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .accent{color:var(--accent)}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:10px;flex:1 1 auto">
        <div class="badge">üì∏ Instagram Carousel Creator <span class="accent">1080√ó1320</span></div>
      </div>
      <button id="addSlideBtn" class="btn">+ –°–ª–∞–π–¥</button>
    </div>
  </header>

  <main class="wrap">
    <div class="row">
      <div class="col" style="flex:1 1 380px">
        <label for="story">–ò—Å—Ç–æ—Ä–∏—è (—Ä–∞–∑–¥–µ–ª—è–π—Ç–µ —Å–ª–∞–π–¥—ã –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π)</label>
        <textarea id="story" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏—Å—Ç–æ—Ä–∏–∏.

–ö–∞–∂–¥—ã–π –∞–±–∑–∞—Ü, –æ—Ç–¥–µ–ª—ë–Ω–Ω—ã–π –ø—É—Å—Ç–æ–π —Å—Ç—Ä–æ–∫–æ–π, —Å—Ç–∞–Ω–µ—Ç –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–ª–∞–π–¥–æ–º."></textarea>

        <details style="margin-top:12px">
          <summary>–î–æ–ø. –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ–∫—Å—Ç–∞ –∏ —Ç–µ–Ω–∏</summary>
          <div class="controls" style="margin-top:10px">
            <div>
              <label>–®—Ä–∏—Ñ—Ç</label>
              <select id="fontFamily">
                <option value="Arial, sans-serif">Arial</option>
                <option value="'Helvetica Neue', Helvetica, Arial, sans-serif">Helvetica</option>
                <option value="'Times New Roman', Times, serif">Times New Roman</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="'Courier New', Courier, monospace">Courier New</option>
              </select>
            </div>
            <div>
              <label>–†–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ (px)</label>
              <input id="fontSize" type="number" min="12" max="96" step="1" value="40" />
            </div>
            <div>
              <label>–ü–æ–ª–æ–∂–µ–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞</label>
              <select id="textPosition">
                <option value="bottom">–°–Ω–∏–∑—É</option>
                <option value="center">–ü–æ —Ü–µ–Ω—Ç—Ä—É</option>
                <option value="top">–°–≤–µ—Ä—Ö—É</option>
              </select>
            </div>
            <div>
              <label>–í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ</label>
              <select id="textAlign">
                <option value="left">–°–ª–µ–≤–∞</option>
                <option value="center">–ü–æ —Ü–µ–Ω—Ç—Ä—É</option>
                <option value="right">–°–ø—Ä–∞–≤–∞</option>
              </select>
            </div>
            <div>
              <label>–û—Ç—Å—Ç—É–ø—ã —Ç–µ–∫—Å—Ç–∞ (px)</label>
              <input id="padding" type="number" min="0" max="160" value="64" />
            </div>
            <div>
              <label>–ú–µ–∂—Å—Ç—Ä–æ—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª</label>
              <input id="lineHeight" type="number" min="1" max="2.4" step="0.05" value="1.25" />
            </div>
            <div>
              <label>–¶–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞</label>
              <input id="textColor" type="text" value="#ffffff" />
            </div>
            <!-- ‚ñº –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º—è–≥–∫–æ–π —Ç–µ–Ω–∏ —Å–Ω–∏–∑—É -->
            <div>
              <label>Fade height (% –æ—Ç —Ö–æ–ª—Å—Ç–∞)</label>
              <input id="overlayHeightPct" type="number" min="5" max="50" step="1" value="22" />
            </div>
            <div>
              <label>Darkest opacity (0‚Äì1)</label>
              <input id="overlayAlpha" type="number" min="0" max="1" step="0.01" value="0.68" />
            </div>
            <div>
              <label>Gradient curve (0.5‚Äì3)</label>
              <input id="overlayCurve" type="number" min="0.5" max="3" step="0.05" value="1.3" />
            </div>
          </div>
        </details>
      </div>

      <div class="col" style="flex:1 1 420px">
        <div class="slideHead"><span>–°–ª–∞–π–¥—ã</span></div>
        <div id="slides" class="slides"></div>
      </div>
    </div>
  </main>

  <footer>
    <button id="clearBtn" class="btn warn clear">Clear Results ‚Äî —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å—ë (—Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)</button>
  </footer>

  <input id="filePicker" type="file" accept="image/*" style="display:none" />

  <script>
    const W = 1080, H = 1320; // 3:4
    const state = {
      slides: [],
      settings: {
        fontFamily: 'Arial, sans-serif',
        fontSize: 40,
        textPosition: 'bottom',
        textAlign: 'left',
        padding: 64,
        lineHeight: 1.25,
        textColor: '#ffffff',
        // ‚ñº –º—è–≥–∫–∞—è —Ç–µ–Ω—å —Å–Ω–∏–∑—É
        overlayHeightPct: 22,   // –≤—ã—Å–æ—Ç–∞ —Ç–µ–Ω–∏ (% –æ—Ç —Ö–æ–ª—Å—Ç–∞)
        overlayAlpha: 0.68,     // –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å —É –Ω–∏–∂–Ω–µ–π –∫—Ä–æ–º–∫–∏
        overlayCurve: 1.3       // 0.5‚Äì3, >1 ‚Äî —Å–∏–ª—å–Ω–µ–µ —É –Ω–∏–∑–∞
      }
    };

    const elStory = document.getElementById('story');
    const elSlides = document.getElementById('slides');
    const elFile = document.getElementById('filePicker');

    // ‚Äî‚Äî‚Äî –¢–µ–∫—Å—Ç ‚Üí —Å–ª–∞–π–¥—ã
    function splitTextToSlides(t){
      const parts = t.replace(/\r/g,'').split(/\n\s*\n/g).map(s=>s.trim()).filter(Boolean);
      const old = state.slides;
      state.slides = parts.map((p,i)=>({ text: p, imgSrc: (old[i] && old[i].imgSrc) || undefined }));
    }

    // –ê–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞–±–æ—Ä–µ
    elStory.addEventListener('input', ()=>{
      splitTextToSlides(elStory.value);
      renderSlidesList(); renderAll();
    });

    document.getElementById('addSlideBtn').addEventListener('click', ()=>{
      state.slides.push({text:'–ù–æ–≤—ã–π —Å–ª–∞–π–¥', imgSrc: undefined});
      renderSlidesList(); renderAll();
    });

    // –ü–æ–ª–Ω—ã–π —Å–±—Ä–æ—Å
    document.getElementById('clearBtn').addEventListener('click', ()=>{
      elStory.value=''; state.slides=[];
      state.settings={...state.settings, fontFamily:'Arial, sans-serif',fontSize:40,textPosition:'bottom',textAlign:'left',padding:64,lineHeight:1.25,textColor:'#ffffff',overlayHeightPct:22,overlayAlpha:0.68,overlayCurve:1.3};
      renderSlidesList(); renderAll();
    });

    // –ê–≤—Ç–æ–ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
    ['fontFamily','fontSize','textPosition','textAlign','padding','lineHeight','textColor','overlayHeightPct','overlayAlpha','overlayCurve']
      .forEach(id=>{
        const el=document.getElementById(id);
        if(!el) return;
        el.addEventListener('input', ()=>{
          const v=(el.type==='number')?parseFloat(el.value):el.value;
          state.settings[id]=isNaN(v)?el.value:v;
          renderAll();
        });
      });

    function createSlideCard(index){
      const wrap=document.createElement('div'); wrap.className='slideCard';
      const head=document.createElement('div'); head.className='slideHead';
      head.innerHTML=`<span>#${index+1}</span><button class="btn secondary" data-edit-text>–¢–µ–∫—Å—Ç</button>`;
      wrap.appendChild(head);

      const c=document.createElement('canvas'); c.width=W; c.height=H; c.className='thumb'; c.dataset.index=index;
      wrap.appendChild(c);

      head.querySelector('[data-edit-text]').addEventListener('click', ()=>{
        const nt=prompt('–ò–∑–º–µ–Ω–∏—Ç—å —Ç–µ–∫—Å—Ç —Å–ª–∞–π–¥–∞', state.slides[index].text||'');
        if(nt!==null){ state.slides[index].text=nt; renderSlideCanvas(c,index); }
      });

      renderSlideCanvas(c,index);
      return wrap;
    }

    function renderSlidesList(){
      elSlides.innerHTML='';
      if(!state.slides.length){
        const empty=document.createElement('div'); empty.className='hint';
        empty.textContent='–ù–∞—á–Ω–∏—Ç–µ —Å —Ç–µ–∫—Å—Ç–∞ ‚Äî —Å–ª–∞–π–¥—ã –ø–æ—è–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.'; elSlides.appendChild(empty); return;
      }
      state.slides.forEach((_,i)=>elSlides.appendChild(createSlideCard(i)));
    }

    function renderAll(){ document.querySelectorAll('canvas.thumb').forEach(cv=>renderSlideCanvas(cv,parseInt(cv.dataset.index,10))); }

    function renderSlideCanvas(cv,index){
      const s=state.slides[index]; const ctx=cv.getContext('2d');
      // —Ñ–æ–Ω
      ctx.fillStyle='#000'; ctx.fillRect(0,0,W,H);

      // –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: cover
      if(s.imgSrc){
        const img=new Image();
        img.onload=()=>{
          const rImg=img.width/img.height, rCan=W/H;
          let sx=0, sy=0, sw=img.width, sh=img.height;
          if(rImg>rCan){ const targetW=img.height*rCan; sx=(img.width-targetW)/2; sw=targetW; }
          else { const targetH=img.width/rCan; sy=(img.height-targetH)/2; sh=targetH; }
          ctx.drawImage(img,sx,sy,sw,sh,0,0,W,H);
          drawOverlayAndText(ctx,s);
        };
        img.src=s.imgSrc;
      } else {
        ctx.fillStyle='#333'; ctx.fillRect(0,0,W,H);
        drawOverlayAndText(ctx,s);
      }
    }

    function drawOverlayAndText(ctx,s){
      // –º—è–≥–∫–∞—è —Ç–µ–Ω—å —Å–Ω–∏–∑—É –ø–æ–¥ —Ç–µ–∫—Å—Ç–æ–º (—Ç–æ–ª—å–∫–æ –∫–æ–≥–¥–∞ –ø–æ–∑–∏—Ü–∏—è ¬´—Å–Ω–∏–∑—É¬ª)
      if(state.settings.textPosition==='bottom'){
        const oh=Math.round(H*(state.settings.overlayHeightPct/100));
        const y0=H, y1=H-oh;                 // –Ω–∏–∑ ‚Üí –≤–µ—Ä—Ö —Ç–µ–Ω–∏
        const g=ctx.createLinearGradient(0,y0,0,y1);
        const steps=24;
        for(let i=0;i<=steps;i++){           // 0..1 –æ—Ç –Ω–∏–∑–∞ –≤–≤–µ—Ä—Ö
          const t=i/steps;
          const a=state.settings.overlayAlpha*Math.pow(1-t,state.settings.overlayCurve);
          g.addColorStop(1-t,`rgba(0,0,0,${a})`);
        }
        ctx.fillStyle=g; ctx.fillRect(0,y1,W,oh);
      }

      // —Ç–µ–∫—Å—Ç
      ctx.save();
      const fs=state.settings.fontSize, lh=Math.max(1,state.settings.lineHeight)*fs;
      ctx.font=`${fs}px ${state.settings.fontFamily}`;
      ctx.textAlign=state.settings.textAlign;
      ctx.fillStyle=state.settings.textColor;

      const pad=state.settings.padding, maxW=W-pad*2;
      const words=(s.text||'').split(/\s+/); const lines=[]; let line='';
      for(const w of words){ const test=line?line+' '+w:w; if(ctx.measureText(test).width>maxW && line){lines.push(line); line=w;} else {line=test;} }
      if(line) lines.push(line);

      let y;
      if(state.settings.textPosition==='bottom') y=H-pad;
      else if(state.settings.textPosition==='top') y=pad+fs;
      else y=H/2-(lines.length-1)*lh/2;

      const x=state.settings.textAlign==='left'?pad:(state.settings.textAlign==='center'?W/2:W-pad);
      for(const ln of lines){ ctx.fillText(ln,x,y); y+=lh; }
      ctx.restore();
    }

    renderSlidesList();
  </script>
</body>
</html>
