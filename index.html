<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Instagram Carousel Creator</title>
  <style>
    :root{
      --bg:#0f1115;--panel:#171a21;--ink:#e8ecf1;--muted:#98a2b3;--accent:#7c9cff;--line:#222736;--btn:#23293a;--warn:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    header{position:sticky;top:0;z-index:5;background:linear-gradient(180deg,var(--bg),rgba(15,17,21,.6));backdrop-filter: blur(6px);}
    .wrap{max-width:960px;margin:0 auto;padding:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1 1 320px;background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:12px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    textarea{width:100%;min-height:140px;resize:vertical;background:#0a0c12;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:10px;font-size:14px;line-height:1.5}
    select,input[type="number"],input[type="text"]{width:100%;background:#0a0c12;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:8px}
    .controls{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{appearance:none;border:1px solid var(--line);background:var(--btn);color:var(--ink);padding:10px 12px;border-radius:12px;font-weight:600}
    .btn.secondary{background:#0a0c12}
    .btn.warn{background:#2b0f13;border-color:#3a1218;color:#ffb4b4}
    .hint{color:var(--muted);font-size:12px}
    details{background:#0a0c12;border:1px solid var(--line);border-radius:12px;padding:10px}
    summary{cursor:pointer;color:var(--ink);font-weight:600}

    /* Slides list â€” vertical */
    .slides{display:flex;flex-direction:column;gap:14px;overflow-y:auto;max-height:70vh;padding-right:4px}
    .slideCard{position:relative;background:#0b0e15;border:1px solid var(--line);border-radius:14px;padding:10px}
    .slideHead{display:flex;align-items:center;justify-content:space-between;font-size:12px;color:var(--muted);margin-bottom:8px}
    canvas.thumb{width:100%;height:auto;border-radius:10px;border:1px solid var(--line);background:#000;touch-action:none}

    footer{display:flex;justify-content:center;padding:24px}
    .clear{opacity:.8}

    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 8px;border-radius:999px;background:#101522;border:1px solid var(--line);font-size:12px;color:var(--muted)}
    .accent{color:var(--accent)}
  </style>
</head>
<body>
  <header>
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:10px;flex:1 1 auto">
        <div class="badge">ðŸ“¸ Instagram Carousel Creator <span class="accent">1080Ã—1350</span></div>
      </div>
      <!-- +Slide removed by request -->
    </div>
  </header>

  <main class="wrap">
    <div class="row">
      <div class="col" style="flex:1 1 380px">
        <label for="story">Story (separate slides with an empty line)</label>
        <textarea id="story" placeholder="Paste your story here.

Each paragraph separated by an empty line becomes a new slide."></textarea>
        <div class="hint" style="margin-top:8px">Auto-save every ~3s (this session). Slides generate automatically.</div>

        <details style="margin-top:12px">
          <summary>Text & overlay settings</summary>
          <div class="controls" style="margin-top:10px">
            <div>
              <label>Font family</label>
              <select id="fontFamily">
                <option value="Arial, sans-serif">Arial</option>
                <option value="'Helvetica Neue', Helvetica, Arial, sans-serif">Helvetica</option>
                <option value="'Times New Roman', Times, serif">Times New Roman</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="'Courier New', Courier, monospace">Courier New</option>
              </select>
            </div>
            <div>
              <label>Font size (px) â€” default 45</label>
              <input id="fontSize" type="number" min="12" max="120" step="1" value="45" />
            </div>
            <div>
              <label>Text alignment</label>
              <select id="textAlign">
                <option value="left">Left</option>
                <option value="center">Center</option>
                <option value="right">Right</option>
              </select>
            </div>
            <div>
              <label>Text padding (px)</label>
              <input id="padding" type="number" min="0" max="120" value="24" />
            </div>
            <div>
              <label>Line height</label>
              <input id="lineHeight" type="number" min="1" max="2.4" step="0.1" value="1.4" />
            </div>
            <div>
              <label>Text color</label>
              <input id="textColor" type="text" value="#ffffff" />
            </div>
            <div>
              <label>Overlay darkness (0â€“1)</label>
              <input id="overlayAlpha" type="number" min="0" max="1" step="0.05" value="0.35" />
            </div>
            <div>
              <label>Overlay height (%)</label>
              <input id="overlayHeightPct" type="number" min="15" max="90" value="42" />
            </div>
            <div>
              <label>Bottom offset (px)</label>
              <input id="bottomOffset" type="number" min="0" max="200" value="0" />
            </div>
          </div>
        </details>
      </div>

      <div class="col" style="flex:1 1 420px">
        <div class="slideHead"><span>Slides</span>
          <div class="hint">Long press â€” download JPG â€¢ Use the button below to replace photo â€¢ Drag photo to reposition</div>
        </div>
        <div id="slides" class="slides"></div>
      </div>
    </div>
  </main>

  <footer>
    <button id="clearBtn" class="btn warn clear">Clear Results â€” reset all (text, photos, settings)</button>
  </footer>

  <input id="filePicker" type="file" accept="image/*" style="display:none" />

  <script>
    // --- App State ---
    const W = 1080, H = 1350; // 4:5 portrait
    const state = {
      slides: [], // { text: string, imgSrc?: dataURL, offset:{x,y} }
      settings: {
        fontFamily: 'Arial, sans-serif',
        fontSize: 45,
        textAlign: 'left',
        padding: 24,
        lineHeight: 1.4,
        textColor: '#ffffff',
        overlayAlpha: 0.35,
        overlayHeightPct: 42,
        bottomOffset: 0,
      },
      autosaveTS: 0
    };

    // --- DOM ---
    const elStory = document.getElementById('story');
    const elSlides = document.getElementById('slides');
    const elFile = document.getElementById('filePicker');

    // bind settings
    const bindSetting = (id, key, transform=(v)=>v, rev=(v)=>v) => {
      const el = document.getElementById(id);
      el.value = rev(state.settings[key]);
      el.addEventListener('input', () => { state.settings[key] = transform(el.value); renderAll(); queueAutosave(); });
    };
    bindSetting('fontFamily','fontFamily');
    bindSetting('fontSize','fontSize', v=>parseInt(v,10));
    bindSetting('textAlign','textAlign');
    bindSetting('padding','padding', v=>parseInt(v,10));
    bindSetting('lineHeight','lineHeight', v=>parseFloat(v));
    bindSetting('textColor','textColor');
    bindSetting('overlayAlpha','overlayAlpha', v=>parseFloat(v));
    bindSetting('overlayHeightPct','overlayHeightPct', v=>parseInt(v,10));
    bindSetting('bottomOffset','bottomOffset', v=>parseInt(v,10));

    // --- Slides from text (auto) ---
    function splitTextToSlides(t){
      const parts = t.replace(/\r/g,'').split(/\n\s*\n/g).map(s=>s.trim()).filter(Boolean);
      const old = state.slides;
      state.slides = parts.map((p,i)=>({
        text: p,
        imgSrc: (old[i] && old[i].imgSrc) || undefined,
        offset: (old[i] && old[i].offset) || {x:0,y:0}
      }));
      renderSlidesList();
      renderAll();
    }
    elStory.addEventListener('input', ()=>{ splitTextToSlides(elStory.value); queueAutosave(); });

    // --- Rendering ---
    function createSlideCard(index){
      const s = state.slides[index];
      const wrap = document.createElement('div');
      wrap.className = 'slideCard';

      const c = document.createElement('canvas');
      c.width = W; c.height = H; c.className='thumb';
      c.dataset.index = index;
      attachCanvasHandlers(c, index);
      wrap.appendChild(c);

      const replaceBtn = document.createElement('button');
      replaceBtn.className = 'btn secondary';
      replaceBtn.textContent = 'Replace photo';
      replaceBtn.addEventListener('click', (e)=>{ e.stopPropagation(); replacePhoto(index); });
      wrap.appendChild(replaceBtn);

      renderSlideCanvas(c, index);
      return wrap;
    }

    function renderSlidesList(){
      elSlides.innerHTML = '';
      state.slides.forEach((_,i)=>{ elSlides.appendChild(createSlideCard(i)); });
      if(state.slides.length===0){
        const empty = document.createElement('div');
        empty.className='hint';
        empty.textContent = 'No slides yet. Type your story â€” slides appear automatically.';
        elSlides.appendChild(empty);
      }
    }

    function renderAll(){
      document.querySelectorAll('canvas.thumb').forEach(cv=>{
        const idx = parseInt(cv.dataset.index,10);
        renderSlideCanvas(cv, idx);
      });
    }

    function renderSlideCanvas(cv, index){
      const s = state.slides[index];
      const ctx = cv.getContext('2d');
      ctx.fillStyle = '#000'; ctx.fillRect(0,0,W,H);

      const drawTextAtBottom = ()=>{
        ctx.save();
        const fs = state.settings.fontSize;
        const lh = Math.max(1, state.settings.lineHeight) * fs;
        ctx.font = `${fs}px ${state.settings.fontFamily}`;
        ctx.textAlign = state.settings.textAlign;
        const pad = state.settings.padding;
        const maxW = W - pad*2;

        // wrap lines
        const words = (s.text||'').split(/\s+/);
        const lines = []; let line = '';
        for(const w of words){
          const test = line ? line + ' ' + w : w;
          if(ctx.measureText(test).width > maxW && line){ lines.push(line); line = w; }
          else { line = test; }
        }
        if(line) lines.push(line);

        // overlay at bottom
        const overlayH = Math.round(H * (state.settings.overlayHeightPct/100));
        const baseY = H - overlayH - state.settings.bottomOffset;

        ctx.fillStyle = `rgba(0,0,0,${state.settings.overlayAlpha})`;
        ctx.fillRect(0, baseY, W, overlayH);

        const align = state.settings.textAlign;
        const x = align==='left' ? pad : (align==='center' ? W/2 : W - pad);
        let y = baseY + pad + fs;
        ctx.fillStyle = state.settings.textColor;
        for(const ln of lines){
          ctx.fillText(ln, x, y);
          y += lh;
          if(y > baseY + overlayH - pad) break;
        }
        ctx.restore();
      };

      if(s.imgSrc){
        const img = new Image();
        img.onload = ()=>{
          // contain/cover hybrid with user offset to let user reposition image
          const rImg = img.width / img.height, rCan = W / H;
          let dw=W, dh=H;
          if(rImg > rCan){ dh = W / rImg; dw = W; } else { dw = H * rImg; dh = H; }
          const cx = (W - dw)/2 + (s.offset?.x||0);
          const cy = (H - dh)/2 + (s.offset?.y||0);
          ctx.drawImage(img, cx, cy, dw, dh);
          drawTextAtBottom();
        };
        img.src = s.imgSrc;
      } else {
        // gradient placeholder + text
        const g = ctx.createLinearGradient(0,0,0,H);
        g.addColorStop(0,'#1a2030'); g.addColorStop(1,'#0c1020');
        ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
        drawTextAtBottom();
      }
    }

    // --- Interactions ---
    function attachCanvasHandlers(cv, index){
      let timer=null, isDragging=false, last={x:0,y:0};

      const start = (e)=>{
        e.preventDefault();
        isDragging=false; last=getPoint(e, cv);
        // long press = download
        timer = setTimeout(()=>{ if(!isDragging){ downloadSlide(index); } }, 650);
      };
      const move = (e)=>{
        const s = state.slides[index]; if(!s.imgSrc) return;
        const pt = getPoint(e, cv);
        if(Math.hypot(pt.x-last.x, pt.y-last.y)>2){
          isDragging=true; clearTimeout(timer);
          s.offset = s.offset || {x:0,y:0};
          s.offset.x += pt.x - last.x; s.offset.y += pt.y - last.y;
          last = pt; renderSlideCanvas(cv, index); queueAutosave();
        }
      };
      const end = (e)=>{ e.preventDefault(); clearTimeout(timer); };

      cv.addEventListener('touchstart', start, {passive:false});
      cv.addEventListener('touchmove',  move,  {passive:false});
      cv.addEventListener('touchend',   end,   {passive:false});
      cv.addEventListener('mousedown', start);
      cv.addEventListener('mousemove', move);
      cv.addEventListener('mouseup',   end);
    }

    function getPoint(e, el){
      if(e.touches && e.touches[0]){ const t=e.touches[0]; const r=el.getBoundingClientRect(); return {x:t.clientX-r.left, y:t.clientY-r.top}; }
      const r=el.getBoundingClientRect(); return {x:e.clientX-r.left, y:e.clientY-r.top};
    }

    function replacePhoto(index){
      elFile.onchange = async (e)=>{
        const file = e.target.files && e.target.files[0];
        if(!file) return;
        const dataURL = await fileToDataURL(file);
        state.slides[index].imgSrc = dataURL;
        state.slides[index].offset = {x:0,y:0};
        renderAll(); queueAutosave(); elFile.value='';
      };
      elFile.click();
    }

    function fileToDataURL(file){
      return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); });
    }

    function downloadSlide(index){
      const off = document.createElement('canvas'); off.width=W; off.height=H;
      renderSlideCanvas(off, index);
      const a = document.createElement('a'); a.href = off.toDataURL('image/jpeg', 0.92); a.download = `slide-${index+1}.jpg`;
      document.body.appendChild(a); a.click(); a.remove();
    }

    // --- Autosave in sessionStorage ---
    const SAVE_KEY = 'icc_session_v3';
    function queueAutosave(){ state.autosaveTS = Date.now(); }
    setInterval(()=>{
      if(!state.autosaveTS) return;
      if(Date.now() - state.autosaveTS >= 2900){
        try {
          const payload = { slides: state.slides, settings: state.settings, story: elStory.value };
          sessionStorage.setItem(SAVE_KEY, JSON.stringify(payload));
          state.autosaveTS = 0;
        } catch(e){}
      }
    }, 1000);

    function restore(){
      try{
        const raw = sessionStorage.getItem(SAVE_KEY); if(!raw) return; const data = JSON.parse(raw);
        Object.assign(state.settings, data.settings||{});
        ['fontFamily','fontSize','textAlign','padding','lineHeight','textColor','overlayAlpha','overlayHeightPct','bottomOffset']
          .forEach(id=>{ if(document.getElementById(id)) document.getElementById(id).value = state.settings[id]; });
        state.slides = (data.slides||[]).map(s=>({text:s.text||'', imgSrc:s.imgSrc, offset:s.offset||{x:0,y:0}}));
        elStory.value = data.story || '';
      }catch(e){}
    }

    // --- Clear (reset to defaults) ---
    document.getElementById('clearBtn').addEventListener('click', ()=>{
      if(!confirm('Reset everything to defaults?')) return;
      state.slides = []; elStory.value = '';
      Object.assign(state.settings, {
        fontFamily: 'Arial, sans-serif',
        fontSize: 45,
        textAlign: 'left',
        padding: 24,
        lineHeight: 1.4,
        textColor: '#ffffff',
        overlayAlpha: 0.35,
        overlayHeightPct: 42,
        bottomOffset: 0,
      });
      ['fontFamily','fontSize','textAlign','padding','lineHeight','textColor','overlayAlpha','overlayHeightPct','bottomOffset']
        .forEach(id=>{ if(document.getElementById(id)) document.getElementById(id).value = state.settings[id]; });
      sessionStorage.removeItem(SAVE_KEY);
      renderSlidesList(); renderAll();
    });

    // --- Init ---
    restore();
    renderSlidesList(); renderAll();
    if(elStory.value) splitTextToSlides(elStory.value);
  </script>
</body>
</html>
